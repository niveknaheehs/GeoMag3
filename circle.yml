#
# Build configuration for Circle CI
#

#general:
#    artifacts:
#        - /home/ubuntu/Geomag3/app/build/outputs/apk/

machine:
    environment:
        ANDROID_HOME: /usr/local/android-sdk-linux
        QEMU_AUDIO_DRV: none

#dependencies:
#    pre:
#      - echo y | android update sdk --no-ui --all --filter "android-24, build-tools-25.0.2"
#    override:
#        - echo y | android update sdk --no-ui --all --filter tools,platform-tools,build-tools-19.1.0,android-19,extra-google-m2repository,extra-google-google_play_services,extra-android-support
#        - chmod +x gradlew
#        - ANDROID_HOME=/usr/local/android-sdk-linux ./gradlew dependencies

dependencies:
    pre:
        - echo y | android update sdk --no-ui --all --filter "android-24"
        # Android SDK Platform 25 Build Tools
        - echo y | android update sdk --no-ui --all --filter "tools"
        # Android SDK Platform Tools 24.0.2
        - echo y | android update sdk --no-ui --all --filter "platform-tools"
        # Android SDK Build-tools, revision 24.0.2
        - echo y | android update sdk --no-ui --all --filter "build-tools-24.0.1"
        # Android Support Repository, revision 35 / Local Maven repository for Support Libraries
        - echo y | android update sdk --no-ui --all --filter "extra-android-m2repository"
        # Android 24 ARM Google APIs system Image
        - echo y | android update sdk --no-ui --all --filter "sys-img-armeabi-v7a-google_apis-24"
        # Create the android 24 AVD
        - echo no | android create avd -n circleci-android24-googleapis -t 'android-24' --abi google_apis/armeabi-v7a
        - |
        # software rendering is broken in revision 10, we'll use revision 08
        - wget "https://dl-ssl.google.com/android/repository/sys-img/google_apis/armeabi-v7a-24_r08.zip"
        - unzip armeabi-v7a-24_r08.zip
        # overwrite some of the new files with older files
        - mv armeabi-v7a/* /usr/local/android-sdk-linux/system-images/android-24/google_apis/armeabi-v7a
        - rm armeabi-v7a-24_r08.zip
   override:
        - echo y | android update sdk --no-ui --all --filter tools,platform-tools,build-tools-19.1.0,android-19,extra-google-m2repository,extra-google-google_play_services,extra-android-support
        - chmod +x gradlew
        - ANDROID_HOME=/usr/local/android-sdk-linux ./gradlew dependencies
test:
    override:
      - emulator -avd circleci-android24-googleapis -no-window -gpu off:
          background: true
          parallel: true
      - circle-android wait-for-boot
      # run tests  against the emulator
      - ./gradlew connectedAndroidTest:
          timeout: 720
#test:
#    override:
#        - (./gradlew assemble):
#            timeout: 360
#        - ./gradlew test
#        - ./gradlew connectedAndroidTest
#    pre:
#        - emulator -avd circleci-android22 -no-window:
#          background: true
#          parallel: true
#        - circle-android wait-for-boot

    post:
        - mkdir -p $CIRCLE_TEST_REPORTS/junit/
        - find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
        - find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
